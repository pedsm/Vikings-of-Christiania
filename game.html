<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Vikings of Christiania</title>
    <script src="p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <link rel="stylesheet" type="text/css" href="login.css">
    <link rel="stylesheet" type="text/css" href="style.css">

    <body style="margin:0px;">
        <div id="container" class="container">
            <img class="logo" src="logo.png" />
            <form id="login-form">
                <input id="nameInput" type="text" placeholder="Enter Name" name="name">
                <div>
                    <button type="submit">Play!</button>
                </div>
            </form>
        </div>
        <script src="sketch.js"/></script>
        <script>
            var socket = io();
			var cur;
            var form = document.getElementById("login-form");

			// Fire a bullet
			fire = ()=>{ socket.emit('fire'); }

            form.onsubmit = function () {
                var playername = document.getElementById("nameInput").value;
                Player.name = playername;
                socket.emit('join_game', {name: playername});
                console.log("Joining game!");

                var last_x = Number.MIN_VALUE;
                var last_y = Number.MIN_VALUE;
                var last_direction = Number.MIN_VALUE;
                setInterval(() => {
					cur = Date.now()

                    // Only update if player position changes
                    if (last_y != Player.y || last_x != Player.x || last_direction != Player.direction) {
                        socket.emit('update_gamestate', Player);
                        last_y = Player.y;
                        last_x = Player.x;
                        last_direction = Player.direction;
                    }
                }, 1000/60)

                // Remove form
                document.getElementsByClassName("container")[0].remove();
                loop();
                return false;
            }

            console.log("connected to ws")
            socket.on('consts'(constants)=>{
                bulletSpeed = constants.bulletSpeed
                playerSpeed = constants.playerSpeed
            })
            // Receive a gamestate update
            // This could either be a player movement, a player disconnection or a full update
            // We will handle each one individually
            socket.on('gamestate', (remoteGamestate) => {
                switch(remoteGamestate.type) {

                    // Update an other players gamestate
                    case "player_update":
                        var rm_player = remoteGamestate.data; // Remote player
                        // Don't update if it is our gamestate
                        if (rm_player.id == socket.id) {
                            return;
                        }

                        var gs_player = gameState.players.filter(
                            (p) => p.id == remoteGamestate.data.id)[0];
                        if (!gs_player) {
                            // Create player
                            gameState.players.push(rm_player);
                        }
                        else {
                            // Update the old player data
                            gs_player.x = rm_player.x;
                            gs_player.y = rm_player.y;
                            gs_player.direction = rm_player.direction;
                            gs_player.speed = rm_player.speed;
                        }
                        break;
                    case "player_disconnect":
                        gameState.players = gameState.players.filter((p) => p.id != remoteGamestate.data);
                        break;
                    case "full_update":
                        gameState.players = remoteGamestate.data.filter((p) => p.id != socket.id);
                        break;
                    default:
                        console.log(`Received unknown gamestate update type:`)
                        console.log(remoteGamestate)
                        break;
                }
            })

        </script>

    </body>

</html>
